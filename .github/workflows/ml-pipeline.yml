name: ML Pipeline

on:
  # Scheduled run: Every Sunday at 2 AM
  schedule:
    - cron: '0 2 * * 0'

  # Manual trigger with options
  workflow_dispatch:
    inputs:
      run_dataops:
        description: 'Run DataOps pipeline (ingestion, validation, transformation)'
        required: false
        default: 'true'
        type: boolean
      run_training:
        description: 'Run model training'
        required: false
        default: 'true'
        type: boolean
      promote_model:
        description: 'Promote trained model to champion'
        required: false
        default: 'false'
        type: boolean

env:
  PYTHON_VERSION: "3.12"
  POETRY_VERSION: "2.0.0"

jobs:
  # ============================================
  # DataOps Pipeline
  # ============================================
  dataops:
    name: üìä DataOps Pipeline
    runs-on: self-hosted
    if: ${{ github.event_name == 'schedule' || github.event.inputs.run_dataops == 'true' }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: pipx install poetry==${{ env.POETRY_VERSION }}

      - name: Cache Poetry dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pypoetry
            .venv
          key: poetry-${{ runner.os }}-${{ hashFiles('poetry.lock') }}

      - name: Install dependencies
        run: poetry install --no-interaction

      - name: Start Infrastructure
        run: docker compose up -d postgres minio mlflow
        continue-on-error: true

      - name: Wait for services
        run: sleep 30

      - name: Run DataOps Pipeline
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
        run: |
          PYTHONPATH=src poetry run python -m house_pricing.dataops.pipeline

      - name: Commit DVC files
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add data/*.dvc .gitignore
          git diff --staged --quiet || git commit -m "chore: Update data versions [skip ci]"
          git push || echo "No changes to push"

  # ============================================
  # Model Training
  # ============================================
  training:
    name: üß† Model Training
    runs-on: self-hosted
    needs: dataops
    if: |
      always() &&
      (needs.dataops.result == 'success' || needs.dataops.result == 'skipped') &&
      (github.event_name == 'schedule' || github.event.inputs.run_training == 'true')

    outputs:
      model_version: ${{ steps.train.outputs.version }}
      run_id: ${{ steps.train.outputs.run_id }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: pipx install poetry==${{ env.POETRY_VERSION }}

      - name: Install dependencies
        run: poetry install --no-interaction

      - name: Ensure services are running
        run: docker compose up -d postgres minio mlflow

      - name: Wait for MLflow
        run: |
          for i in {1..30}; do
            if curl -sf http://localhost:5000/health; then
              echo "MLflow is ready!"
              break
            fi
            echo "Waiting for MLflow... ($i/30)"
            sleep 5
          done

      - name: Run Training
        id: train
        env:
          MLFLOW_TRACKING_URI: http://localhost:5000
          AWS_ACCESS_KEY_ID: ${{ secrets.MINIO_ROOT_USER }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.MINIO_ROOT_PASSWORD }}
          MLFLOW_S3_ENDPOINT_URL: http://localhost:9000
        run: |
          PYTHONPATH=src poetry run python -m house_pricing.models.train
          # Extract version from MLflow
          echo "version=1" >> $GITHUB_OUTPUT
          echo "run_id=$(date +%s)" >> $GITHUB_OUTPUT

  # ============================================
  # Model Promotion (Optional)
  # ============================================
  promote:
    name: üèÜ Promote Model
    runs-on: self-hosted
    needs: training
    if: |
      github.event.inputs.promote_model == 'true' &&
      needs.training.result == 'success'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: pipx install poetry==${{ env.POETRY_VERSION }}

      - name: Install dependencies
        run: poetry install --no-interaction

      - name: Promote to Champion
        env:
          MLFLOW_TRACKING_URI: http://localhost:5000
        run: |
          poetry run python -c "
          import mlflow
          client = mlflow.MlflowClient()
          # Get latest version
          versions = client.search_model_versions('name=\"HousePricing_random_forest\"')
          if versions:
              latest = max(versions, key=lambda v: int(v.version))
              client.set_registered_model_alias(
                  'HousePricing_random_forest',
                  'champion',
                  latest.version
              )
              print(f'‚úÖ Promoted version {latest.version} to @champion')
          "

      - name: Trigger API Reload
        run: |
          curl -X POST http://localhost:8000/model/reload \
            -H "X-API-KEY: ${{ secrets.API_KEY }}" || true
